# .github/pull-request.yml
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã†
# ãƒ—ãƒ«ãƒªã‚¯ã‚’å‡ºã—ãŸã¨ãã«ã€è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
## ãƒ†ã‚¹ãƒˆã®çµæœã¯ã‚³ãƒ¡ãƒ³ãƒˆã§é€šçŸ¥ã—ã¦ãã ã•ã„
# ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã¯æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹
# ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã¯ä»¥ä¸‹ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„
# - ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„
# - ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒä¸è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ãªã„

name: Pull Request

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install flake8

      - name: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆflake8ï¼‰
        id: lint
        continue-on-error: true
        run: |
          echo "## ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ" > lint_results.md
          echo "" >> lint_results.md
          echo "### flake8ãƒã‚§ãƒƒã‚¯çµæœ" >> lint_results.md
          echo "" >> lint_results.md
          echo '```' >> lint_results.md
          flake8 src/ tests/ --exclude=__pycache__ --max-line-length=120 --format=default || true >> lint_results.md
          echo '```' >> lint_results.md

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v6
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const lintContent = fs.existsSync('lint_results.md') 
              ? fs.readFileSync('lint_results.md', 'utf8') 
              : '## ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\nâœ… ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã¯ä¸è¦ã§ã™ã€‚';
            
            const body = `## ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n${lintContent}\n\n---\n*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  test:
    needs: review
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰
        run: |
          docker compose up -d db selenium
          sleep 10

      - name: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          docker compose build web

      - name: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        run: |
          docker compose up -d web
          sleep 15

      - name: å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: unit_test
        continue-on-error: true
        run: |
          docker compose exec -T web python -m pytest tests/unit/ -v --tb=short > unit_test_results.txt 2>&1 || true

      - name: çµåˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: integration_test
        continue-on-error: true
        run: |
          docker compose exec -T web python -m pytest tests/integration/ -v --tb=short > integration_test_results.txt 2>&1 || true

      - name: UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: ui_test
        continue-on-error: true
        run: |
          docker compose exec -T web python -m pytest tests/ui/ -v --tb=short > ui_test_results.txt 2>&1 || true

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’é›†è¨ˆ
        run: |
          echo "## ãƒ†ã‚¹ãƒˆçµæœ" > test_results.md
          echo "" >> test_results.md
          
          # å˜ä½“ãƒ†ã‚¹ãƒˆçµæœ
          echo "### å˜ä½“ãƒ†ã‚¹ãƒˆ" >> test_results.md
          echo "" >> test_results.md
          if [ -f unit_test_results.txt ]; then
            echo '```' >> test_results.md
            tail -50 unit_test_results.txt >> test_results.md
            echo '```' >> test_results.md
          else
            echo "ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> test_results.md
          fi
          echo "" >> test_results.md
          
          # çµåˆãƒ†ã‚¹ãƒˆçµæœ
          echo "### çµåˆãƒ†ã‚¹ãƒˆ" >> test_results.md
          echo "" >> test_results.md
          if [ -f integration_test_results.txt ]; then
            echo '```' >> test_results.md
            tail -50 integration_test_results.txt >> test_results.md
            echo '```' >> test_results.md
          else
            echo "ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> test_results.md
          fi
          echo "" >> test_results.md
          
          # UIãƒ†ã‚¹ãƒˆçµæœ
          echo "### UIãƒ†ã‚¹ãƒˆ" >> test_results.md
          echo "" >> test_results.md
          if [ -f ui_test_results.txt ]; then
            echo '```' >> test_results.md
            tail -50 ui_test_results.txt >> test_results.md
            echo '```' >> test_results.md
          else
            echo "ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> test_results.md
          fi
          echo "" >> test_results.md
          
          # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼
          unit_failed=$(grep -c "FAILED" unit_test_results.txt 2>/dev/null || echo "0")
          integration_failed=$(grep -c "FAILED" integration_test_results.txt 2>/dev/null || echo "0")
          ui_failed=$(grep -c "FAILED" ui_test_results.txt 2>/dev/null || echo "0")
          
          echo "## ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼" >> test_results.md
          echo "" >> test_results.md
          echo "- å˜ä½“ãƒ†ã‚¹ãƒˆå¤±æ•—æ•°: $unit_failed" >> test_results.md
          echo "- çµåˆãƒ†ã‚¹ãƒˆå¤±æ•—æ•°: $integration_failed" >> test_results.md
          echo "- UIãƒ†ã‚¹ãƒˆå¤±æ•—æ•°: $ui_failed" >> test_results.md
          echo "" >> test_results.md
          
          total_failed=$((unit_failed + integration_failed + ui_failed))
          if [ $total_failed -eq 0 ]; then
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼" >> test_results.md
          else
            echo "âŒ $total_failed ä»¶ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚" >> test_results.md
          fi

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v6
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const testContent = fs.existsSync('test_results.md') 
              ? fs.readFileSync('test_results.md', 'utf8') 
              : '## ãƒ†ã‚¹ãƒˆçµæœ\n\nãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';
            
            const body = `## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ\n\n${testContent}\n\n---\n*ã“ã®çµæœã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          docker compose down -v