# .github/pull-request.yml
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡Œã†
# ãƒ—ãƒ«ãƒªã‚¯ã‚’å‡ºã—ãŸã¨ãã«ã€è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
## ãƒ†ã‚¹ãƒˆã®çµæœã¯ã‚³ãƒ¡ãƒ³ãƒˆã§é€šçŸ¥ã—ã¦ãã ã•ã„
# ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã¯æ—¥æœ¬èªã§è¨˜è¿°ã™ã‚‹
# ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã¯ä»¥ä¸‹ã®é …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„
# - ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„
# - ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒä¸è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ãªã„

name: Pull Request

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install flake8

      - name: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆflake8ï¼‰
        id: lint
        continue-on-error: true
        run: |
          echo "## ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ" > lint_results.md
          echo "" >> lint_results.md
          echo "### flake8ãƒã‚§ãƒƒã‚¯çµæœ" >> lint_results.md
          echo "" >> lint_results.md
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
          if [ ! -d "src" ] && [ ! -d "tests" ]; then
            echo "âš ï¸ src/ ã¾ãŸã¯ tests/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" >> lint_results.md
          else
            echo '```' >> lint_results.md
            LINT_OUTPUT=""
            if [ -d "src" ] && [ -d "tests" ]; then
              LINT_OUTPUT=$(flake8 src/ tests/ --exclude=__pycache__ --max-line-length=120 --format=default 2>&1) || true
            elif [ -d "src" ]; then
              LINT_OUTPUT=$(flake8 src/ --exclude=__pycache__ --max-line-length=120 --format=default 2>&1) || true
            elif [ -d "tests" ]; then
              LINT_OUTPUT=$(flake8 tests/ --exclude=__pycache__ --max-line-length=120 --format=default 2>&1) || true
            fi
            
            if [ -n "$LINT_OUTPUT" ]; then
              echo "$LINT_OUTPUT" >> lint_results.md
            else
              echo "âœ… flake8ãƒã‚§ãƒƒã‚¯ã§å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" >> lint_results.md
            fi
            echo '```' >> lint_results.md
          fi

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let lintContent = '## ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\nâœ… ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã¯ä¸è¦ã§ã™ã€‚';
            
            if (fs.existsSync('lint_results.md')) {
              lintContent = fs.readFileSync('lint_results.md', 'utf8');
            }
            
            const body = `## ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n${lintContent}\n\n---\n*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç•ªå·ã‚’å–å¾—
            const prNumber = context.payload.pull_request?.number || context.payload.number || context.issue.number;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  test:
    needs: review
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰
        run: |
          docker compose up -d db selenium
          sleep 10

      - name: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰
        run: |
          docker compose build web

      - name: Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
        run: |
          docker compose up -d web
          sleep 15

      - name: å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: unit_test
        continue-on-error: true
        run: |
          docker compose exec -T web python -m pytest tests/unit/ -v --tb=short > unit_test_results.txt 2>&1 || true

      - name: çµåˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: integration_test
        continue-on-error: true
        run: |
          docker compose exec -T web python -m pytest tests/integration/ -v --tb=short > integration_test_results.txt 2>&1 || true

      - name: UIãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        id: ui_test
        continue-on-error: true
        run: |
          docker compose exec -T web python -m pytest tests/ui/ -v --tb=short > ui_test_results.txt 2>&1 || true

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’å–å¾—
        if: always()
        continue-on-error: true
        run: |
          # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p screenshots
          # ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒ›ã‚¹ãƒˆã«ã‚³ãƒ”ãƒ¼
          docker compose cp web:/usr/src/app/screenshots/. screenshots/ 2>/dev/null || true
          # src/screenshots/ã«ã‚‚ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦ã‚³ãƒ”ãƒ¼
          if [ -d "src/screenshots" ]; then
            cp -r src/screenshots/* screenshots/ 2>/dev/null || true
          fi

      - name: ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-screenshots
          path: screenshots/
          if-no-files-found: ignore
          retention-days: 7

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’é›†è¨ˆ
        run: |
          echo "## ãƒ†ã‚¹ãƒˆçµæœ" > test_results.md
          echo "" >> test_results.md
          
          # å˜ä½“ãƒ†ã‚¹ãƒˆçµæœ
          echo "### å˜ä½“ãƒ†ã‚¹ãƒˆ" >> test_results.md
          echo "" >> test_results.md
          if [ -f unit_test_results.txt ]; then
            echo '```' >> test_results.md
            tail -50 unit_test_results.txt >> test_results.md
            echo '```' >> test_results.md
          else
            echo "ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> test_results.md
          fi
          echo "" >> test_results.md
          
          # çµåˆãƒ†ã‚¹ãƒˆçµæœ
          echo "### çµåˆãƒ†ã‚¹ãƒˆ" >> test_results.md
          echo "" >> test_results.md
          if [ -f integration_test_results.txt ]; then
            echo '```' >> test_results.md
            tail -50 integration_test_results.txt >> test_results.md
            echo '```' >> test_results.md
          else
            echo "ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> test_results.md
          fi
          echo "" >> test_results.md
          
          # UIãƒ†ã‚¹ãƒˆçµæœ
          echo "### UIãƒ†ã‚¹ãƒˆ" >> test_results.md
          echo "" >> test_results.md
          if [ -f ui_test_results.txt ]; then
            echo '```' >> test_results.md
            tail -50 ui_test_results.txt >> test_results.md
            echo '```' >> test_results.md
          else
            echo "ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚" >> test_results.md
          fi
          echo "" >> test_results.md
          
          # ãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼
          unit_failed=$(grep -c "FAILED" unit_test_results.txt 2>/dev/null || echo "0")
          integration_failed=$(grep -c "FAILED" integration_test_results.txt 2>/dev/null || echo "0")
          ui_failed=$(grep -c "FAILED" ui_test_results.txt 2>/dev/null || echo "0")
          
          echo "## ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼" >> test_results.md
          echo "" >> test_results.md
          echo "- å˜ä½“ãƒ†ã‚¹ãƒˆå¤±æ•—æ•°: $unit_failed" >> test_results.md
          echo "- çµåˆãƒ†ã‚¹ãƒˆå¤±æ•—æ•°: $integration_failed" >> test_results.md
          echo "- UIãƒ†ã‚¹ãƒˆå¤±æ•—æ•°: $ui_failed" >> test_results.md
          echo "" >> test_results.md
          
          total_failed=$((unit_failed + integration_failed + ui_failed))
          if [ $total_failed -eq 0 ]; then
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼" >> test_results.md
          else
            echo "âŒ $total_failed ä»¶ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚" >> test_results.md
          fi

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let testContent = '## ãƒ†ã‚¹ãƒˆçµæœ\n\nãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';
            
            if (fs.existsSync('test_results.md')) {
              testContent = fs.readFileSync('test_results.md', 'utf8');
            }
            
            const body = `## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ\n\n${testContent}\n\n---\n*ã“ã®çµæœã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç•ªå·ã‚’å–å¾—
            const prNumber = context.payload.pull_request?.number || context.payload.number || context.issue.number;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          docker compose down -v