# コーディング規約

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | コーディング規約 |
| バージョン | 1.0 |
| 作成日 | 2024-10-31 |
| 最終更新日 | 2024-10-31 |
| 作成者 | 開発チーム |

## 2. 基本方針

- **可読性**: コードは読みやすく、理解しやすく記述する
- **保守性**: 将来の修正・拡張を考慮したコード構造にする
- **一貫性**: プロジェクト全体で一貫したコーディングスタイルを維持する
- **日本語対応**: コメント、docstringは日本語で記述する

## 3. Pythonコーディング規約

### 3.1 コーディングスタイル

**PEP 8準拠:**
- Pythonの公式コーディング規約PEP 8に準拠する
- 必要に応じて、linter（flake8、pylint等）を使用する

### 3.2 インデント

- **4スペース**を使用（タブは使用しない）
- 行の継続は括弧、角括弧、波括弧を使用

```python
# 良い例
if condition:
    do_something()

# 悪い例
if condition:
	do_something()  # タブ使用
```

### 3.3 命名規則

#### 3.3.1 変数・関数名

- **スネークケース**を使用
- 説明的な名前を使用

```python
# 良い例
employee_id = 1
user_name = "田中太郎"
def get_employee_by_id(employee_id):
    pass

# 悪い例
id = 1  # 意味が不明確
n = "田中太郎"  # 意味が不明確
def get(id):  # 引数名が不明確
    pass
```

#### 3.3.2 クラス名

- **パスカルケース**を使用

```python
# 良い例
class DBAccess:
    pass

class AttendanceRecord:
    pass

# 悪い例
class db_access:  # スネークケース
    pass
```

#### 3.3.3 定数

- **大文字のスネークケース**を使用

```python
# 良い例
MAX_RETRY_COUNT = 3
DEFAULT_TIMEOUT = 30

# 悪い例
maxRetryCount = 3  # キャメルケース
```

### 3.4 インポート

- 標準ライブラリ、サードパーティ、ローカルモジュールの順にグループ化
- 各グループの間には空行を1行入れる

```python
# 良い例
import os
from datetime import date, datetime

from flask import Flask, render_template
import pymysql

from applications.DBAccess import DBAccess
from applications.db_init import init_database
```

### 3.5 コメント

#### 3.5.1 クラスコメント

- すべてのクラスには日本語のdocstringを記述する

```python
class DBAccess:
    """
    DBAccessクラスは、MySQLデータベースへの接続を管理するクラスです。
    
    このクラスは、データベース接続の確立、SQLクエリの実行、
    トランザクション管理などの機能を提供します。
    """
    pass
```

#### 3.5.2 メソッドコメント

- すべてのメソッドには日本語のdocstringを記述する
- 引数、戻り値の説明を含める

```python
def execute_query(self, query, params=None):
    """
    MySQLデータベースにクエリを実行するメソッドです。
    
    Args:
        query (str): 実行するSQLクエリ
        params (tuple, optional): クエリパラメータ。デフォルトはNone。
    
    Returns:
        list: クエリ結果のリスト
    
    Raises:
        Exception: クエリ実行エラー時
    """
    pass
```

#### 3.5.3 インラインコメント

- 複雑なロジックには日本語のコメントを追加
- コメントは「#」を使用し、コードの右側または上に配置

```python
# 良い例
# パスワードをSHA-256でハッシュ化
password_hash = hashlib.sha256(password.encode()).hexdigest()

# 悪い例
# hash password
password_hash = hashlib.sha256(password.encode()).hexdigest()  # 英語コメント
```

### 3.6 エラーハンドリング

- 例外処理を適切に実装する
- 例外は具体的にキャッチする

```python
# 良い例
try:
    db.execute_query(query, params)
    db.commit()
except pymysql.Error as e:
    db.rollback()
    flash(f'データベースエラー: {str(e)}', 'error')
except Exception as e:
    flash(f'エラー: {str(e)}', 'error')
finally:
    db.close_connection()
```

### 3.7 関数・メソッドの長さ

- 1つの関数・メソッドは50行以内を目安とする
- 長くなる場合は分割を検討する

### 3.8 型ヒント（推奨）

- 将来的な拡張として型ヒントを使用することを推奨

```python
# 推奨（将来の拡張）
from typing import List, Optional

def get_employee_by_id(employee_id: int) -> Optional[dict]:
    """
    社員IDから社員情報を取得する関数です。
    
    Args:
        employee_id (int): 社員ID
    
    Returns:
        Optional[dict]: 社員情報の辞書。存在しない場合はNone。
    """
    pass
```

## 4. Flask特有の規約

### 4.1 ルーティング

- ルート関数には日本語のdocstringを記述する
- HTTPメソッドを明示的に指定する

```python
@app.route('/employees', methods=['GET'])
@login_required
@manager_required
def employees_list():
    """
    社員一覧ページ（課長のみ）
    
    Returns:
        str: 社員一覧ページのHTML
    """
    pass
```

### 4.2 テンプレート

- テンプレートファイルは`templates/`ディレクトリに配置
- テンプレート名はスネークケースを使用

```
templates/
├── base.html
├── login.html
├── dashboard.html
├── attendance_input.html
└── employees_list.html
```

### 4.3 セッション管理

- セッションキーは明確な名前を使用
- セッションに保存するデータは最小限にする

```python
# 良い例
session['user_id'] = user['id']
session['user_name'] = user['name']
session['user_role'] = user['role']

# 悪い例
session['id'] = user['id']  # 意味が不明確
```

## 5. データベース関連規約

### 5.1 SQLクエリ

- **パラメータ化クエリ**を使用（SQLインジェクション対策）
- 複雑なクエリにはコメントを追加

```python
# 良い例
db.execute_query(
    """
    SELECT id, name, email
    FROM employees
    WHERE id = %s
    """,
    (employee_id,)
)

# 悪い例（SQLインジェクションのリスク）
query = f"SELECT * FROM employees WHERE id = {employee_id}"
```

### 5.2 トランザクション管理

- データ更新処理は必ずトランザクション内で実行
- エラー時は必ずロールバック
- finally節でコネクションを閉じる

```python
db = DBAccess()
try:
    db.execute_query(query, params)
    db.commit()
except Exception as e:
    db.rollback()
    flash(f'エラー: {str(e)}', 'error')
finally:
    db.close_connection()
```

## 6. テストコード規約

### 6.1 テストファイル命名

- テストファイルは`test_`で始まる
- テストファイルは`tests/`ディレクトリに配置

```
tests/
├── unit/
│   ├── test_app.py
│   └── test_dbaccess.py
└── ui/
    ├── test_login.py
    └── test_attendance.py
```

### 6.2 テストクラス・メソッド命名

- テストクラスは`Test`で始まる
- テストメソッドは`test_`で始まる

```python
class TestLoginPage(BaseSeleniumTest):
    """
    ログインページのテストクラスです。
    """
    
    def test_login_success(self):
        """
        ログイン成功のテストです。
        """
        pass
```

### 6.3 テストの構造

- Arrange（準備）、Act（実行）、Assert（検証）の構造を明確にする

```python
def test_login_success(self):
    """
    ログイン成功のテストです。
    """
    # Arrange（準備）
    email = "employee@example.com"
    password = "password123"
    
    # Act（実行）
    self.driver.get(f"{self.base_url}/login")
    self.driver.find_element(By.NAME, "email").send_keys(email)
    self.driver.find_element(By.NAME, "password").send_keys(password)
    self.driver.find_element(By.CSS_SELECTOR, "button[type='submit']").click()
    
    # Assert（検証）
    self.assertIn("/dashboard", self.driver.current_url)
```

## 7. Git運用規約

### 7.1 コミットメッセージ

- コミットメッセージは日本語で記述する
- 形式: `[種別] 変更内容の簡潔な説明`

**種別:**
- `[追加]`: 新機能の追加
- `[修正]`: バグ修正
- `[変更]`: 機能変更・リファクタリング
- `[削除]`: 機能削除
- `[ドキュメント]`: ドキュメント追加・更新

**例:**
```
[追加] 勤怠入力機能を実装
[修正] ログイン時のバリデーションエラーを修正
[変更] データベース接続処理をリファクタリング
[ドキュメント] README.mdを更新
```

### 7.2 ブランチ命名

- ブランチ名は説明的にする
- 形式: `feature/機能名`、`fix/バグ修正内容`

**例:**
```
feature/attendance-input
fix/login-validation-error
refactor/db-connection
```

## 8. ファイル構成

### 8.1 ディレクトリ構造

```
work_report/
├── src/
│   ├── app.py                    # メインアプリケーション
│   ├── applications/
│   │   ├── DBAccess.py          # データベースアクセス
│   │   └── db_init.py           # データベース初期化
│   └── templates/               # HTMLテンプレート
├── tests/                       # テストコード
├── docs/                        # 設計書
├── compose.yaml                 # Docker Compose設定
├── Dockerfile                   # Dockerイメージ定義
├── README.md                    # プロジェクト説明
└── AGENTS.md                    # AIエージェント用ガイドライン
```

### 8.2 ファイル命名

- Pythonファイル: スネークケース
- HTMLファイル: スネークケース
- 設定ファイル: 小文字

## 9. コーディングチェックリスト

コードレビュー時のチェック項目:

- [ ] PEP 8に準拠しているか
- [ ] クラス・メソッドに日本語のdocstringがあるか
- [ ] 変数・関数名が説明的か
- [ ] エラーハンドリングが適切か
- [ ] SQLインジェクション対策がされているか（パラメータ化クエリ）
- [ ] トランザクション管理が適切か
- [ ] テストコードが作成されているか
- [ ] コメントが適切に記述されているか

## 10. 参考資料

- [PEP 8 -- Style Guide for Python Code](https://peps.python.org/pep-0008/)
- [Flask Documentation](https://flask.palletsprojects.com/)
- [Python Docstring Conventions](https://peps.python.org/pep-0257/)

