# 開発環境構築手順書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | 開発環境構築手順書 |
| バージョン | 1.0 |
| 作成日 | 2024-10-31 |
| 最終更新日 | 2024-10-31 |
| 作成者 | 開発チーム |

## 2. 前提条件

### 2.1 必要なソフトウェア

以下のソフトウェアがインストールされている必要があります：

| ソフトウェア | バージョン | 確認コマンド |
|------------|-----------|------------|
| Docker | 20.10以上 | `docker --version` |
| Docker Compose | 2.0以上 | `docker compose version` |
| Git | 最新版推奨 | `git --version` |

### 2.2 システム要件

| 項目 | 要件 |
|------|------|
| OS | Linux、macOS、Windows（WSL2） |
| CPU | 2コア以上推奨 |
| メモリ | 4GB以上推奨 |
| ディスク容量 | 10GB以上の空き容量 |

## 3. 開発環境構築手順

### 3.1 リポジトリのクローン

```bash
# リポジトリをクローン
git clone <repository-url>
cd work_report
```

### 3.2 Docker環境の確認

```bash
# Dockerの動作確認
docker --version
docker compose version

# Dockerデーモンの起動確認
docker ps
```

### 3.3 プロジェクトのビルドと起動

```bash
# Docker Composeでコンテナをビルドして起動
docker compose up -d --build

# ログを確認しながら起動（開発時）
docker compose up --build
```

### 3.4 サービスの確認

```bash
# 起動中のコンテナを確認
docker compose ps

# 期待される出力:
# NAME                STATUS          PORTS
# work_report-db-1     running         0.0.0.0:3306->3306/tcp
# work_report-web-1   running         0.0.0.0:5000->5000/tcp
# work_report-phpmyadmin-1 running     0.0.0.0:8080->80/tcp
# work_report-selenium-1 running       0.0.0.0:4444->4444/tcp, 0.0.0.0:7900->5900/tcp
```

### 3.5 データベースの初期化確認

```bash
# Webコンテナのログを確認
docker compose logs web

# 以下のメッセージが表示されていれば成功:
# データベースの初期化が完了しました。
```

### 3.6 アプリケーションへのアクセス確認

ブラウザで以下のURLにアクセスして動作確認：

- **ログインページ**: http://localhost:5000/login
- **phpMyAdmin**: http://localhost:8080

## 4. 開発環境の設定

### 4.1 環境変数の設定

環境変数は`compose.yaml`で管理されています。必要に応じて編集してください。

```yaml
# compose.yaml
services:
  web:
    environment:
      FLASK_ENV: development
      MYSQL_HOST: db
      MYSQL_USER: root
      MYSQL_PASSWORD: rootpassword
      MYSQL_DATABASE: flask_db
```

### 4.2 ボリュームマウント

ソースコードは自動的にマウントされているため、編集が即座に反映されます：

```yaml
volumes:
  - ./src:/usr/src/app
  - ./tests:/usr/src/app/tests
```

## 5. 開発時の作業フロー

### 5.1 コードの編集

1. エディタで`src/`配下のファイルを編集
2. Flaskの開発モードでは、コード変更が自動的に反映されます（再起動不要）
3. ブラウザで動作確認

### 5.2 データベースの確認

phpMyAdminでデータベースを確認：

1. http://localhost:8080 にアクセス
2. サーバー: `db`
3. ユーザー名: `root`
4. パスワード: `rootpassword`
5. データベース `flask_db` を選択

### 5.3 ログの確認

```bash
# すべてのサービスのログ
docker compose logs -f

# 特定のサービスのログ
docker compose logs -f web
docker compose logs -f db
```

### 5.4 コンテナ内でのコマンド実行

```bash
# Webコンテナでシェルを実行
docker compose exec web bash

# Python対話シェルを起動
docker compose exec web python

# データベースに直接接続
docker compose exec db mysql -u root -prootpassword flask_db
```

## 6. テストの実行

### 6.1 単体テストの実行

```bash
# すべての単体テストを実行
docker compose exec web python -m pytest tests/unit/ -v

# 特定のテストファイルを実行
docker compose exec web python -m pytest tests/unit/test_app.py -v
```

### 6.2 UIテストの実行

```bash
# すべてのUIテストを実行
docker compose exec web python -m pytest tests/ui/ -v

# 特定のテストファイルを実行
docker compose exec web python -m pytest tests/ui/test_login.py -v
```

### 6.3 すべてのテストの実行

```bash
# すべてのテストを実行
docker compose exec web python -m pytest tests/ -v
```

## 7. トラブルシューティング

### 7.1 コンテナが起動しない

```bash
# コンテナの状態を確認
docker compose ps

# ログを確認
docker compose logs

# コンテナを再作成
docker compose down
docker compose up -d --build
```

### 7.2 ポートが既に使用されている

`compose.yaml`のポート設定を変更：

```yaml
services:
  web:
    ports:
      - "5001:5000"  # 5000の代わりに5001を使用
```

### 7.3 データベース接続エラー

```bash
# MySQLコンテナが起動しているか確認
docker compose ps db

# MySQLコンテナのログを確認
docker compose logs db

# MySQLコンテナを再起動
docker compose restart db

# データベースを再初期化
docker compose down -v
docker compose up -d --build
```

### 7.4 コードの変更が反映されない

```bash
# コンテナを再起動
docker compose restart web

# または、コンテナを再作成
docker compose down
docker compose up -d --build
```

### 7.5 テストが失敗する

```bash
# Seleniumコンテナが正常に動作しているか確認
curl http://localhost:4444/wd/hub/status

# テスト用のパッケージがインストールされているか確認
docker compose exec web python -m pip list | grep -E "(selenium|pytest)"

# テストパッケージを再インストール
docker compose exec web pip install -r tests/requirements.txt
```

## 8. 開発時のベストプラクティス

### 8.1 コード編集前の確認

- 最新のコードを取得: `git pull`
- ブランチを作成: `git checkout -b feature/機能名`

### 8.2 コード編集後

1. テストを実行して動作確認
2. コミット: `git commit -m "[追加] 機能名"`
3. プッシュ: `git push`

### 8.3 データベースのリセット

開発中にデータベースをリセットする場合：

```bash
# ボリュームを削除して再初期化
docker compose down -v
docker compose up -d --build
```

**注意**: この操作により、すべてのデータが削除されます。

## 9. IDE・エディタ設定

### 9.1 VS Code推奨設定

`.vscode/settings.json`を作成：

```json
{
    "python.defaultInterpreterPath": "/usr/local/bin/python",
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": false,
    "python.linting.flake8Enabled": true,
    "python.formatting.provider": "black",
    "editor.formatOnSave": true,
    "[python]": {
        "editor.tabSize": 4,
        "editor.insertSpaces": true
    }
}
```

### 9.2 Pythonパスの設定

プロジェクトルートに`.pythonpath`ファイルを作成（必要に応じて）：

```
src
```

## 10. 外部ツールの導入（オプション）

### 10.1 コードフォーマッター

Blackを使用する場合：

```bash
# コンテナ内でインストール
docker compose exec web pip install black

# コードをフォーマット
docker compose exec web black src/
```

### 10.2 Linter

flake8を使用する場合：

```bash
# コンテナ内でインストール
docker compose exec web pip install flake8

# コードをチェック
docker compose exec web flake8 src/
```

## 11. 環境ごとの設定

### 11.1 開発環境

- `FLASK_ENV=development`
- デバッグモード有効
- エラーメッセージ詳細表示

### 11.2 本番環境（将来拡張）

- `FLASK_ENV=production`
- デバッグモード無効
- エラーメッセージ簡略化
- セキュアな設定

## 12. 確認事項

開発環境構築後、以下を確認してください：

- [ ] Docker、Docker Composeが正常に動作している
- [ ] すべてのコンテナが起動している
- [ ] アプリケーションにアクセスできる（http://localhost:5000）
- [ ] phpMyAdminにアクセスできる（http://localhost:8080）
- [ ] データベースが初期化されている
- [ ] テストが実行できる
- [ ] コードの変更が反映される

## 13. 参考資料

- [Docker Documentation](https://docs.docker.com/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Flask Documentation](https://flask.palletsprojects.com/)

