# テスト仕様書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | テスト仕様書 |
| バージョン | 1.0 |
| 作成日 | 2024-10-31 |
| 最終更新日 | 2024-10-31 |
| 作成者 | 開発チーム |

## 2. テスト方針

### 2.1 テストの目的

- システムが仕様通りに動作することを確認する
- バグを早期に発見し、品質を保証する
- リグレッション（回帰バグ）を防止する

### 2.2 テストの種類

| テスト種別 | 説明 | 実行タイミング |
|-----------|------|--------------|
| 単体テスト | 関数・メソッド単位のテスト | 実装後 |
| 結合テスト | モジュール間の連携テスト | 機能実装後 |
| UIテスト | ブラウザでの動作確認テスト | 機能完成後 |
| システムテスト | システム全体の動作確認 | リリース前 |

### 2.3 テスト環境

- **実行環境**: Dockerコンテナ
- **テストフレームワーク**: pytest
- **UIテストツール**: Selenium

## 3. 単体テスト仕様

### 3.1 テスト対象

| モジュール | テストファイル | 対象関数・クラス |
|-----------|--------------|----------------|
| applications/DBAccess.py | tests/unit/test_dbaccess.py | DBAccessクラス |
| 時間フォーマット処理 | tests/unit/test_time_formatting.py | 時間変換関数 |
| アプリケーションロジック | tests/unit/test_app.py | ルート関数 |

### 3.2 テストケース一覧

#### 3.2.1 DBAccessクラスのテスト

| テストID | テスト項目 | 期待結果 |
|---------|-----------|---------|
| UT001 | データベース接続成功 | 接続が確立される |
| UT002 | execute_query正常系 | クエリが正常に実行され、結果が返る |
| UT003 | execute_query異常系（SQLエラー） | 例外が発生する |
| UT004 | commit正常系 | トランザクションがコミットされる |
| UT005 | rollback正常系 | トランザクションがロールバックされる |

#### 3.2.2 時間フォーマット処理のテスト

| テストID | テスト項目 | 入力 | 期待結果 |
|---------|-----------|------|---------|
| UT101 | timedeltaから文字列への変換 | timedelta(hours=9, minutes=30) | "09:30" |
| UT102 | datetimeから文字列への変換 | datetime(2024, 1, 1, 9, 30) | "09:30" |
| UT103 | 15分単位の時間変換 | timedelta(hours=8, minutes=45) | "08:45" |

#### 3.2.3 アプリケーションロジックのテスト

| テストID | テスト項目 | 期待結果 |
|---------|-----------|---------|
| UT201 | ログイン処理（正常系） | セッションが作成され、ダッシュボードへリダイレクト |
| UT202 | ログイン処理（異常系：パスワード不一致） | エラーメッセージ表示 |
| UT203 | 認証デコレータ（未ログイン） | ログインページへリダイレクト |
| UT204 | 権限チェックデコレータ（社員権限） | ダッシュボードへリダイレクト |

### 3.3 実行方法

```bash
# すべての単体テストを実行
docker compose exec web python -m pytest tests/unit/ -v

# 特定のテストファイルを実行
docker compose exec web python -m pytest tests/unit/test_dbaccess.py -v

# カバレッジ付きで実行（将来拡張）
docker compose exec web python -m pytest tests/unit/ --cov=src --cov-report=html
```

## 4. 結合テスト仕様

### 4.1 テスト対象

| テストID | テスト項目 | 関連モジュール |
|---------|-----------|--------------|
| IT001 | データベース初期化処理 | db_init.py ↔ DBAccess.py |
| IT002 | 勤怠記録登録処理 | app.py ↔ DBAccess.py ↔ データベース |
| IT003 | 時間フォーマット処理の統合 | app.py ↔ 時間フォーマット関数 |

### 4.2 テストケース詳細

#### IT001: データベース初期化処理

**目的**: データベース初期化が正常に動作することを確認

**前提条件**:
- データベースが起動している
- テスト用データベースが存在する

**手順**:
1. `init_database()`を実行
2. テーブルが作成されたことを確認
3. 初期データが投入されたことを確認

**期待結果**:
- employees、projects、attendance_records、project_hoursテーブルが作成される
- テスト用の課長・社員アカウントが作成される
- テスト用のプロジェクトが作成される

#### IT002: 勤怠記録登録処理

**目的**: 勤怠記録の登録から表示までが正常に動作することを確認

**前提条件**:
- ログイン済み
- テスト用の社員アカウントが存在する

**手順**:
1. 勤怠記録を登録
2. データベースにレコードが保存されたことを確認
3. 勤怠詳細画面でレコードが表示されることを確認

**期待結果**:
- attendance_recordsテーブルにレコードが保存される
- プロジェクト作業時間が正しく保存される
- 画面で正しく表示される

### 4.3 実行方法

```bash
# 結合テストを実行
docker compose exec web python -m pytest tests/integration/ -v
```

## 5. UIテスト仕様

### 5.1 テスト対象画面

| 画面 | テストファイル | テスト項目数 |
|------|--------------|------------|
| ログイン画面 | tests/ui/test_login.py | 2 |
| ダッシュボード | tests/ui/test_home_page.py | 2 |
| DBステータス | tests/ui/test_db_status.py | 2 |
| 勤怠入力 | tests/ui/test_attendance.py | 複数 |

### 5.2 テストケース詳細

#### 5.2.1 ログイン画面のテスト

| テストID | テスト項目 | 期待結果 |
|---------|-----------|---------|
| UI001 | ログイン画面が表示される | ログインフォームが表示される |
| UI002 | ログイン成功 | ダッシュボードへリダイレクト |
| UI003 | ログイン失敗（パスワード不一致） | エラーメッセージが表示される |

**テスト実装例:**

```python
def test_login_success(self):
    """ログイン成功のテスト"""
    self.driver.get(f"{self.base_url}/login")
    self.driver.find_element(By.NAME, "email").send_keys("employee@example.com")
    self.driver.find_element(By.NAME, "password").send_keys("password123")
    self.driver.find_element(By.CSS_SELECTOR, "button[type='submit']").click()
    
    # ダッシュボードにリダイレクトされたことを確認
    self.assertIn("/dashboard", self.driver.current_url)
```

#### 5.2.2 ダッシュボードのテスト

| テストID | テスト項目 | 期待結果 |
|---------|-----------|---------|
| UI101 | ダッシュボードが表示される | ダッシュボードのコンテンツが表示される |
| UI102 | ログイン済みでアクセス | 正常に表示される |
| UI103 | 未ログインでアクセス | ログイン画面へリダイレクト |

#### 5.2.3 勤怠入力のテスト

| テストID | テスト項目 | 期待結果 |
|---------|-----------|---------|
| UI201 | 勤怠入力画面が表示される | 入力フォームが表示される |
| UI202 | 勤怠記録の登録 | 登録成功メッセージが表示される |
| UI203 | 勤怠記録の更新 | 更新成功メッセージが表示される |
| UI204 | 必須項目未入力 | バリデーションエラーが表示される |

### 5.3 実行方法

```bash
# すべてのUIテストを実行
docker compose exec web python -m pytest tests/ui/ -v

# 特定のテストファイルを実行
docker compose exec web python -m pytest tests/ui/test_login.py -v

# 詳細な出力付きで実行
docker compose exec web python -m pytest tests/ui/ -v -s
```

### 5.4 Selenium環境の確認

```bash
# Selenium WebDriver Hubの状態確認
curl http://localhost:4444/wd/hub/status

# VNCでブラウザを確認（オプション）
# http://localhost:7900 にアクセス（パスワード: secret）
```

## 6. システムテスト仕様

### 6.1 テストシナリオ

#### シナリオ1: 社員の勤怠入力フロー

**目的**: 社員が勤怠を入力し、確認するまでの一連の流れを確認

**前提条件**:
- 社員アカウントが存在する
- ログイン可能な状態

**手順**:
1. ログイン
2. ダッシュボードを表示
3. 勤怠入力画面を開く
4. 勤怠情報を入力（日付、出勤区分、時間など）
5. 保存
6. ダッシュボードで記録が表示されることを確認
7. 勤怠詳細画面で内容を確認

**期待結果**:
- すべての手順が正常に完了する
- データが正しく保存される
- 画面で正しく表示される

#### シナリオ2: 課長の社員管理フロー

**目的**: 課長が社員を管理する一連の流れを確認

**前提条件**:
- 課長アカウントが存在する
- ログイン可能な状態

**手順**:
1. ログイン（課長権限）
2. 社員一覧画面を表示
3. 新規社員を作成
4. 社員情報を編集
5. 社員を削除
6. 月次レポートを確認

**期待結果**:
- すべての操作が正常に完了する
- データが正しく保存・更新・削除される
- 権限チェックが正常に動作する

### 6.2 非機能テスト

#### 6.2.1 パフォーマンステスト

| テスト項目 | 要件 | 測定方法 |
|-----------|------|---------|
| ページ表示時間 | 2秒以内 | ブラウザの開発者ツール |
| データベースクエリ実行時間 | 1秒以内 | ログから測定 |

#### 6.2.2 セキュリティテスト

| テスト項目 | 期待結果 |
|-----------|---------|
| SQLインジェクション対策 | パラメータ化クエリで対策されている |
| XSS対策 | テンプレートエンジンで自動エスケープされる |
| セッション管理 | 適切にセッションが管理される |
| 権限チェック | 権限がない機能にアクセスできない |

## 7. テストデータ管理

### 7.1 テスト用データ

テスト用の初期データは`db_init.py`で作成されます：

- **課長アカウント**: manager@example.com / password123
- **社員アカウント**: employee@example.com / password123
- **プロジェクト**: プロジェクトA

### 7.2 テストデータのリセット

```bash
# データベースをリセット
docker compose down -v
docker compose up -d --build
```

## 8. テスト実行計画

### 8.1 テスト実行タイミング

| フェーズ | テスト種別 | 実行頻度 |
|---------|-----------|---------|
| 開発中 | 単体テスト | 実装後 |
| 機能完成時 | 結合テスト | 機能完成時 |
| 機能完成時 | UIテスト | 機能完成時 |
| リリース前 | システムテスト | リリース前 |

### 8.2 テスト実行手順

1. **事前準備**
   - Dockerコンテナを起動
   - データベースが正常に動作していることを確認

2. **単体テスト実行**
   ```bash
   docker compose exec web python -m pytest tests/unit/ -v
   ```

3. **結合テスト実行**
   ```bash
   docker compose exec web python -m pytest tests/integration/ -v
   ```

4. **UIテスト実行**
   ```bash
   docker compose exec web python -m pytest tests/ui/ -v
   ```

5. **結果確認**
   - すべてのテストが成功することを確認
   - 失敗したテストがあれば修正

## 9. テスト結果報告

### 9.1 テスト結果の記録

テスト実行後、以下の情報を記録します：

- テスト実行日時
- 実行したテスト数
- 成功したテスト数
- 失敗したテスト数
- 失敗したテストの詳細

### 9.2 テスト結果フォーマット

```bash
# テスト結果をファイルに出力
docker compose exec web python -m pytest tests/ -v --tb=short > test_results.txt
```

## 10. 不具合管理

### 10.1 不具合の発見

テストで不具合が発見された場合：

1. 不具合を再現できる最小の手順を記録
2. 不具合の影響範囲を確認
3. 不具合報告書を作成（必要に応じて）

### 10.2 不具合の修正

1. 不具合を修正
2. 関連するテストを実行して確認
3. リグレッションテストを実行

## 11. テストカバレッジ（将来拡張）

将来的にはテストカバレッジを測定することを推奨：

```bash
# カバレッジ測定
docker compose exec web python -m pytest tests/ --cov=src --cov-report=html

# カバレッジレポートを確認
# htmlcov/index.html をブラウザで開く
```

**目標カバレッジ**: 80%以上

## 12. 参考資料

- [pytest Documentation](https://docs.pytest.org/)
- [Selenium Documentation](https://www.selenium.dev/documentation/)
- [Flask Testing Documentation](https://flask.palletsprojects.com/en/2.1.x/testing/)

